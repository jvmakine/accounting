<!doctype html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Accounting</title>
		<link rel="stylesheet" type="text/css" href="/css/cupertino/jquery-ui-1.10.2.custom.min.css">
		<link rel="stylesheet" type="text/css" href="/css/accounting.css">
		<script type="text/javascript" src="/js/lib/jquery-1.9.1.js"></script>
		<script type="text/javascript" src="/js/lib/jquery-ui-1.10.2.custom.min.js"></script>
		<script type="text/javascript" src="/js/lib/underscore-min.js"></script>
		<script type="text/javascript" src="/js/lib/backbone-min.js"></script>
		<script type="text/javascript" src="/js/backbone-mod.js"></script>
		<script type="text/javascript" src="/js/decorator.js"></script>
		<script type="text/javascript" src="/js/accounting.js"></script>
		<script type="text/javascript">
		
		    var activeAccountId = null;
		    var activeEventId = null;
		
			var makeAccountAccordion = function() {
			  $("#account_container").accordion({ collapsible: true, active: null,
			    beforeActivate: function( event, ui ) {
			      var panel = ui.newPanel;
			      accounting.renderAccountEvents($(panel).children('.account-events'), $(panel).attr("account-id"));
			    },
			    heightStyle: "content"});
			  $(".delete-account-button").unbind('click');
			  $(".delete-account-button").click(function(event) {
		    	event.stopPropagation();
		    	event.preventDefault();
		    	var accountId = $(this).closest("h3").attr("account-id");
		    	activeAccountId = accountId;
		    	$("#delete_account_dialog").dialog("open");
		  	  });
			  $(".delete-account-button").button({
			    icons: { primary: "ui-icon-trash" }
			  });
			  $(".add-event-button").tooltip({
			    content: "Delete the account" 
			  });
			  $(".add-event-button").button({
			    icons: { primary: "ui-icon-plusthick" }
			  });
			  $(".add-event-button").click(function(event) {
		    	event.stopPropagation();
		    	event.preventDefault();
		    	var accountId = $(this).closest("h3").attr("account-id");
		    	activeAccountId = accountId;
		    	clearNewEventForm();
		    	$("#new_event_dialog").dialog("open");
		  	  });
			}
		
			var makeNewAccountDialog = function() {
				$("#new_account_dialog").dialog({
			      	autoOpen: false,
			      	height: 360,
			      	width: 350,
			      	modal: true,
			      	draggable: false,
			      	resizable: false,
			      	buttons: {
			        	"Create": function() {
				          	accounting.createAccount({
					            name: $("#new_account_name").val(),
					            description: $("#new_account_description").val()
					        });
				    	    $("#new_account_dialog").dialog("close");
			        	},
			        	"Cancel": function() { 
			          		$("#new_account_dialog").dialog("close"); 
			        	}
			      	}
	      		});
			}
			
			var makeNewEventDialog = function() {
				$("#new_event_dialog").dialog({
			      	autoOpen: false,
			      	height: 370,
			      	width: 400,
			      	modal: true,
			      	draggable: false,
			      	resizable: false,
			      	buttons: {
			        	"Create": function() {
			        	    var isTransfer = $('#event-transfer').is(':checked')
			        	  	accounting.createEvent({
			        	  	  account_id: activeAccountId,
			        	  	  description: $("#new_event_description").val(),
			        	  	  amount: $("#new_event_amount").val(),
			        	  	  change_type: (isTransfer ? "transfer" : "change"),
			        	  	  event_date: $("#new_event_date").val()
			        	  	})
				    	    $("#new_event_dialog").dialog("close");
			        	},
			        	"Cancel": function() { 
			          		$("#new_event_dialog").dialog("close"); 
			        	}
			      	}
	      		});
				$("#new_event_date").datepicker({ dateFormat: "yy-mm-dd" });
				$("#new_event_date").datepicker( "setDate", "0" );
			}
			
			var makeDeleteConfirmationDialog = function(elem, delete_fn) {
			  elem.dialog({
			    autoOpen: false,
	      		height: 200,
	      		width: 300,
	      		modal: true,
	      		draggable: false,
	      		resizable: false,
	      		buttons: {
	        		"Delete": function() {
	        		  delete_fn();
	        		  elem.dialog("close");
	        		},
	        		"Cancel": function() {
	        		  elem.dialog("close");
	        		}
	      		 }	
			  });
			}
			
			var makeDeleteAccountDialog = function() {
			  makeDeleteConfirmationDialog(
			      $("#delete_account_dialog"),
			      function() {
			        accounting.deleteAccount(activeAccountId);
			      }
			  );
			}
			
			var makeDeleteEventDialog = function() {
			  makeDeleteConfirmationDialog(
			      $("#delete_event_dialog"),
			      function() {
			        accounting.deleteEvent(activeAccountId, activeEventId);
			      }
			  );
			}
			
			var clearNewAccountForm = function() {
				$("#new_account_name").val("");
				$("#new_account_description").val("");
			}
			
			var clearNewEventForm = function() {
				$("#new_event_amount").val("");
				$("#new_event_description").val("");
				$('#event-transfer').attr('checked', false);
				$("#new_event_date").datepicker( "setDate", "0" );
			}
			
			$(function() {
			  makeAccountAccordion();
			  makeNewAccountDialog();
			  makeDeleteAccountDialog();
			  makeDeleteEventDialog();
			  makeNewEventDialog();
			  $("#new_account_button").click(function(e){
			    clearNewAccountForm();
			    $("#new_account_dialog").dialog("open");
			  })
			  accounting.init({
			    onAccountRefresh: function() {
					$("#account_container").accordion('destroy');
					makeAccountAccordion();
			    },
			    onEventListRendered: function() {
			      $(".delete-event-button").button({
				  	icons: { primary: "ui-icon-trash" },
			      });
			      $(".delete-event-button").click(function(e) {
	      		  	$("#delete_event_dialog").dialog("open");
	      		  	var eventId = $(this).closest("tr").attr("event-id");
	      		  	var accountId = $(this).closest("tr").attr("account-id");
	    		   	activeEventId = eventId;
	    		   	activeAccountId = accountId;
	      		  });
			    }
			  });
			});
		</script>
	</head>
	<body>
		<script type="text/template" id="account_template">
			<h3 class="account-name" account-id="<%= id %>" >
			  <span class="account-sum <%= total_class %>">
              	<%= total %> €
			  </span>
			  <span class="account-name">
              	<%= name %>
			  </span>
              <span class="account-toolbar" style="float:right; display: <%= tool_display %>;" class="ui-widget-header ui-corner-all">
				 <div class="add-event-button medium-icon-button"></div>
                 <div class="delete-account-button medium-icon-button"></div>
              </span>
            </h3>
			<div class="account-content" account-id="<%= id %>" >
				<div> <%= description %> </div>
				<table class="account-events">  </table>
			</div>
		</script>
		<script type="text/template" id="event_template">
			<tr class="event-content" event-id="<%= id %>" account-id="<%= account_id %>" >
				<td class="event-amount <%= amount_class %>"> <%= amount %> € </td>
				<td class="event-date"> <%= event_date %> </td>
				<td class="event-description"> <%= description %> </td>
				<td class="event-cumulative <%= cumulative_class %>"> <%= cumulative_amount %> € </td>
				<td class="event-delete"> <div class="delete-event-button small-icon-button"></div> </td>
			</tr>
		</script>
		<div>
			<a href="/logout">Logout</a>
			<a href="#" id="new_account_button">New Account</a>
		</div>
		<div class="accounts" id="account_container">
		</div>
		
		<div id="new_account_dialog" title="Create new account">
			<form>
    			<div class="form-element">
    				<label for="name">Name</label>
    				<input type="text" name="name" id="new_account_name" class="text ui-widget-content ui-corner-all" />
    			</div>
    			<div class="form-element">
    				<label for="description">Description</label>
    				<textarea name="description" id="new_account_description" class="textarea ui-widget-content ui-corner-all"></textarea>
    			</div>
  			</form>
		</div>
		<div id="delete_account_dialog" title="Delete an account">
			Are you sure you want to delete this account?
		</div>
		<div id="delete_event_dialog" title="Delete an event">
			Are you sure you want to delete this event?
		</div>
		<div id="new_event_dialog" title="Create new event">
			<form>
    			<div class="form-element">
    				<label for="description">Description</label>
    				<input type="text" name="description" id="new_event_description" class="text ui-widget-content ui-corner-all" />
    			</div>
    			<div class="form-element">
    				<label for="amount">Amount</label>
    				<input name="amount" id="new_event_amount" type="text" 
    				class="textarea ui-widget-content ui-corner-all" />
    			</div>
    			<div class="form-element">
    				<label for="transfer">Transfer to/from another account</label>
    				<input type="checkbox" name="transfer" id="event-transfer" />
    			</div>
    			<div class="form-element">
    				<label for="event_date">Date of the event</label>
    				<input type="text" name="event_date" id="new_event_date" class="text ui-widget-content ui-corner-all" />
    			</div>
  			</form>
		</div>
	</body>
</html>