<!doctype html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Accounting</title>
		<link rel="stylesheet" type="text/css" href="/css/cupertino/jquery-ui-1.10.2.custom.min.css">
		<link rel="stylesheet" type="text/css" href="/css/accounting.css">
		<script type="text/javascript" src="/js/jquery-1.9.1.js"></script>
		<script type="text/javascript" src="/js/jquery-ui-1.10.2.custom.min.js"></script>
		<script type="text/javascript" src="/js/decorator.js"></script>
		<script type="text/javascript" src="/js/underscore-min.js"></script>
		<script type="text/javascript" src="/js/backbone-min.js"></script>
		<script type="text/javascript" src="/js/accounting.js"></script>
		<script type="text/javascript">
		
		    var activeAccountId = null;
		
			var makeAccountAccordion = function() {
			  $("#account_container").accordion({ collapsible: true, active: null,
			    beforeActivate: function( event, ui ) {
			      var panel = ui.newPanel;
			      accounting.renderAccountEvents($(panel), $(panel).attr("account-id"));
			    }});
			  $(".delete-account-button").unbind('click');
			  $(".delete-account-button").click(function(event) {
		    	event.stopPropagation();
		    	event.preventDefault();
		    	var accountId = $(this).closest("h3").attr("account-id");
		    	activeAccountId = accountId;
		    	$("#delete_account_dialog").dialog("open");
		  	  });
			}
		
			var makeNewAccountDialog = function() {
				$("#new_account_dialog").dialog({
			      	autoOpen: false,
			      	height: 360,
			      	width: 350,
			      	modal: true,
			      	draggable: false,
			      	resizable: false,
			      	buttons: {
			        	"Create": function() {
				          	accounting.createAccount({
					            name: $("#new_account_name").val(),
					            description: $("#new_account_description").val()
					        });
				    	    $("#new_account_dialog").dialog("close");
			        	},
			        	"Cancel": function() { 
			          		$("#new_account_dialog").dialog("close"); 
			        	}
			      	}
	      		});
			}
			
			var makeDeleteAccountDialog = function() {
			  $("#delete_account_dialog").dialog({
			    autoOpen: false,
	      		height: 200,
	      		width: 300,
	      		modal: true,
	      		draggable: false,
	      		resizable: false,
	      		buttons: {
	        		"Delete": function() {
	        		  accounting.deleteAccount(activeAccountId);
	        		  $("#delete_account_dialog").dialog("close");
	        		},
	        		"Cancel": function() {
	        		  $("#delete_account_dialog").dialog("close");
	        		}
	      		 }	
			  });
			}
			
			var clearNewAccountForm = function() {
				$("#new_account_name").val("");
				$("#new_account_description").val("");
			}
			
			$(function() {
			  makeAccountAccordion();
			  makeNewAccountDialog();
			  makeDeleteAccountDialog();
			  $("#new_account_button").click(function(e){
			    clearNewAccountForm();
			    $("#new_account_dialog").dialog("open");
			  })
			  accounting.init({
			    onAccountRefresh: function() {
					$("#account_container").accordion('destroy');
					makeAccountAccordion();
			    }
			  });
			});
		</script>
	</head>
	<body>
		<script type="text/template" id="account_template">
			<h3 class="account-name" account-id="<%= id %>" >
			  <span class="account-sum <%= total_class %>">
              	<%= total %> â‚¬
			  </span>
			  <span class="account-name">
              	<%= name %>
			  </span>
              <span class="account-toolbar" style="float:right;" class="ui-widget-header ui-corner-all">
                 <a href="#" class="delete-account-button">Delete</a>
              </span>
            </h3>
			<div class="account-content" account-id="<%= id %>" >
				<div> <%= description %> </div>
				<div class="account-events">  </div>
			</div>
		</script>
		<script type="text/template" id="event_template">
			<div class="event-content" event-id="<%= id %>" >
				<span class="event-amount <%= amount_class %>"> <%= amount %> </span>
				<span class="event-description"> <%= description %> </span>
			</div>
		</script>
		<div>
			<a href="/logout">Logout</a>
			<a href="#" id="new_account_button">New Account</a>
		</div>
		<div class="accounts" id="account_container"></div>
		
		<div id="new_account_dialog" title="Create new account">
			<form>
    			<div class="form-element">
    				<label for="name">Name</label>
    				<input type="text" name="name" id="new_account_name" class="text ui-widget-content ui-corner-all" />
    			</div>
    			<div class="form-element">
    				<label for="description">Description</label>
    				<textarea name="description" id="new_account_description" class="textarea ui-widget-content ui-corner-all"></textarea>
    			</div>
  			</form>
		</div>
		<div id="delete_account_dialog" title="Delete an account">
			Are you sure you want to delete the account?
		</div>
	</body>
</html>